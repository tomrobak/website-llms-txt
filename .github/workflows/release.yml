name: ğŸš€ Create Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v2.0.0)'
        required: true
        type: string

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ·ï¸ Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
          
      - name: ğŸ“¦ Create plugin zip
        run: |
          # Create build directory
          mkdir -p build/wp-llms-txt
          
          # Copy plugin files excluding development files
          rsync -av --exclude-from=.github/release-exclude.txt . build/wp-llms-txt/
          
          # Create the zip file
          cd build
          zip -r wp-llms-txt-${{ steps.version.outputs.version }}.zip wp-llms-txt/
          
          # Move zip to root for upload
          mv wp-llms-txt-${{ steps.version.outputs.version }}.zip ../
          
      - name: ğŸ“‹ Read changelog
        id: changelog
        run: |
          if [ -f CHANGELOG.md ]; then
            # Extract changelog for this version (between first two headings)
            changelog=$(awk '/^## / {if(found) exit; if(/^## .*${{ steps.version.outputs.version }}/) found=1; next} found' CHANGELOG.md)
            if [ -z "$changelog" ]; then
              changelog="ğŸ‰ New release is here! Check out all the awesome improvements and fixes in this version."
            fi
          else
            changelog="ğŸ‰ New release is here! Check out all the awesome improvements and fixes in this version."
          fi
          
          # Handle multiline output properly
          {
            echo 'CHANGELOG<<EOF'
            echo "$changelog"
            echo EOF
          } >> $GITHUB_OUTPUT
          
      - name: ğŸ‰ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "WP LLMs.txt ${{ steps.version.outputs.version }} ğŸ¤–"
          body: |
            # ğŸš€ WP LLMs.txt ${{ steps.version.outputs.version }}
            
            ${{ steps.changelog.outputs.CHANGELOG }}
            
            ## ğŸ“¥ Installation
            
            1. Download the `wp-llms-txt-${{ steps.version.outputs.version }}.zip` file below
            2. Upload to your WordPress site via **Plugins > Add New > Upload Plugin**
            3. Activate and configure in **Settings > LLMS.txt Generator**
            
            ## ğŸ”§ Requirements
            
            - PHP 8.3 or higher
            - WordPress 6.7 or higher
            - Write permissions in `wp-content/uploads/`
            
            ## ğŸ¤– What's LLMS.txt?
            
            LLMS.txt files help AI systems like ChatGPT, Claude, and Perplexity discover and understand your website content. This plugin makes your WordPress site AI-discoverable!
            
            ---
            
            Made with â¤ï¸ and a lot of â˜• by [Tom Robak](https://wplove.co)
          files: |
            wp-llms-txt-${{ steps.version.outputs.version }}.zip
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸŠ Success notification
        run: |
          echo "ğŸ‰ Release ${{ steps.version.outputs.version }} created successfully!"
          echo "ğŸ“¦ Plugin zip: wp-llms-txt-${{ steps.version.outputs.version }}.zip"