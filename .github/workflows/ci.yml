name: ğŸ§ª Continuous Integration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  php-quality-checks:
    name: ğŸ” PHP Quality & Compatibility
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        php-version: ['8.3', '8.4']
        
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ˜ Setup PHP ${{ matrix.php-version }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: mbstring, xml, json, curl
          tools: composer, phpcs, phpstan
          coverage: none
          
      - name: ğŸ“‹ Validate composer.json
        run: |
          if [ -f composer.json ]; then
            composer validate --strict
          else
            echo "âœ… No composer.json found - WordPress plugin doesn't require it"
          fi
          
      - name: ğŸ” PHP Syntax Check
        run: |
          echo "ğŸ” Checking PHP syntax for all PHP files..."
          find . -name "*.php" -not -path "./vendor/*" -not -path "./node_modules/*" | while read file; do
            echo "Checking: $file"
            php -l "$file"
            if [ $? -ne 0 ]; then
              echo "âŒ Syntax error in: $file"
              exit 1
            fi
          done
          echo "âœ… All PHP files have valid syntax!"
          
      - name: ğŸ¯ PHP 8.3+ Features Validation
        run: |
          echo "ğŸ¯ Validating modern PHP 8.3+ features..."
          
          # Check for strict types declaration
          echo "Checking for strict_types declarations..."
          if ! grep -r "declare(strict_types=1);" --include="*.php" includes/ admin/ >/dev/null 2>&1; then
            echo "âš ï¸ Warning: Some PHP files may be missing strict_types declarations"
          else
            echo "âœ… Strict types declarations found"
          fi
          
          # Check for typed properties
          echo "Checking for typed properties..."
          if grep -r "private.*\$.*;" --include="*.php" includes/ >/dev/null 2>&1; then
            echo "âœ… Typed properties detected"
          fi
          
          # Check for return type declarations
          echo "Checking for return type declarations..."
          if grep -r "function.*):.*{" --include="*.php" includes/ >/dev/null 2>&1; then
            echo "âœ… Return type declarations found"
          fi
          
          # Check for readonly properties
          echo "Checking for readonly properties..."
          if grep -r "readonly" --include="*.php" includes/ >/dev/null 2>&1; then
            echo "âœ… Readonly properties detected"
          fi
          
          echo "ğŸ‰ Modern PHP 8.3+ features validation completed!"
          
      - name: ğŸ›¡ï¸ WordPress Security Checks
        run: |
          echo "ğŸ›¡ï¸ Running WordPress security checks..."
          
          # Check for ABSPATH protection
          echo "Checking ABSPATH protection..."
          failed_files=()
          find . -name "*.php" -not -path "./vendor/*" -not -path "./test-*" | while read file; do
            if ! grep -q "ABSPATH" "$file"; then
              echo "âš ï¸ Missing ABSPATH check: $file"
              failed_files+=("$file")
            fi
          done
          
          # Check for nonce verification in AJAX handlers
          echo "Checking AJAX nonce verification..."
          if grep -r "wp_ajax" --include="*.php" . >/dev/null 2>&1; then
            if grep -r "check_ajax_referer\|wp_verify_nonce" --include="*.php" . >/dev/null 2>&1; then
              echo "âœ… AJAX nonce verification found"
            else
              echo "âš ï¸ Warning: AJAX handlers found but no nonce verification detected"
            fi
          fi
          
          # Check for SQL injection protection
          echo "Checking SQL injection protection..."
          if grep -r "\$wpdb->prepare" --include="*.php" . >/dev/null 2>&1; then
            echo "âœ… Prepared statements detected"
          fi
          
          # Check for XSS protection
          echo "Checking XSS protection..."
          if grep -r "esc_html\|esc_attr\|esc_url" --include="*.php" . >/dev/null 2>&1; then
            echo "âœ… Output escaping functions detected"
          fi
          
          echo "ğŸ‰ Security checks completed!"

  wordpress-compatibility:
    name: ğŸ”§ WordPress Compatibility
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ˜ Setup PHP 8.3
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, json, curl, mysql
          
      - name: ğŸ“¦ Setup WordPress Test Environment
        run: |
          # Download WordPress
          wget https://wordpress.org/latest.tar.gz
          tar -xzf latest.tar.gz
          
          # Check WordPress version compatibility
          WP_VERSION=$(grep "wp_version =" wordpress/wp-includes/version.php | cut -d"'" -f2)
          echo "WordPress version: $WP_VERSION"
          
          # Verify minimum requirements
          if php -r "exit(version_compare('$WP_VERSION', '6.7', '<') ? 1 : 0);"; then
            echo "âœ… WordPress $WP_VERSION meets minimum requirement (6.7+)"
          else
            echo "âŒ WordPress $WP_VERSION does not meet minimum requirement (6.7+)"
            exit 1
          fi
          
      - name: ğŸ” Plugin Structure Validation
        run: |
          echo "ğŸ” Validating WordPress plugin structure..."
          
          # Check main plugin file
          if [ -f "website-llms-txt.php" ]; then
            echo "âœ… Main plugin file found"
            
            # Check plugin headers
            if grep -q "Plugin Name:" website-llms-txt.php; then
              echo "âœ… Plugin Name header found"
            else
              echo "âŒ Missing Plugin Name header"
              exit 1
            fi
            
            if grep -q "Version:" website-llms-txt.php; then
              echo "âœ… Version header found"
            else
              echo "âŒ Missing Version header"
              exit 1
            fi
            
            if grep -q "Requires PHP: 8.3" website-llms-txt.php; then
              echo "âœ… PHP 8.3+ requirement specified"
            else
              echo "âŒ Missing or incorrect PHP requirement"
              exit 1
            fi
            
            if grep -q "Requires at least: 6.7" website-llms-txt.php; then
              echo "âœ… WordPress 6.7+ requirement specified"
            else
              echo "âŒ Missing or incorrect WordPress requirement"
              exit 1
            fi
          else
            echo "âŒ Main plugin file not found"
            exit 1
          fi
          
          # Check directory structure
          for dir in includes admin; do
            if [ -d "$dir" ]; then
              echo "âœ… $dir directory found"
            else
              echo "âš ï¸ $dir directory not found"
            fi
          done
          
          # Check for uninstall
          if [ -f "uninstall.php" ]; then
            echo "âœ… Uninstall script found"
          else
            echo "âš ï¸ No uninstall script found"
          fi
          
          echo "ğŸ‰ Plugin structure validation completed!"

  code-standards:
    name: ğŸ“ Code Standards & Style
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ˜ Setup PHP 8.3
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          tools: phpcs
          
      - name: ğŸ“ WordPress Coding Standards
        run: |
          # Install WordPress Coding Standards if composer.json exists
          if [ -f composer.json ]; then
            composer install --dev --no-progress
          else
            echo "ğŸ“¦ Installing PHPCS and WordPress standards globally..."
            composer global require squizlabs/php_codesniffer
            composer global require wp-coding-standards/wpcs
            
            # Set installed paths
            ~/.composer/vendor/bin/phpcs --config-set installed_paths ~/.composer/vendor/wp-coding-standards/wpcs
          fi
          
          echo "ğŸ” Running WordPress coding standards check..."
          
          # Run PHPCS with WordPress standards (warnings only for now)
          if command -v phpcs >/dev/null 2>&1; then
            phpcs --standard=WordPress --extensions=php --ignore=vendor/,node_modules/,test-*.php . || true
          elif [ -f ~/.composer/vendor/bin/phpcs ]; then
            ~/.composer/vendor/bin/phpcs --standard=WordPress --extensions=php --ignore=vendor/,node_modules/,test-*.php . || true
          else
            echo "âš ï¸ PHPCS not available, skipping coding standards check"
          fi
          
          echo "âœ… Code standards check completed"

  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”’ Security Vulnerability Scan
        run: |
          echo "ğŸ”’ Running security vulnerability scan..."
          
          # Check for common WordPress security issues
          echo "Checking for common security vulnerabilities..."
          
          # SQL injection patterns
          if grep -r "\\$_[A-Z].*\\$wpdb" --include="*.php" . 2>/dev/null; then
            echo "âš ï¸ Potential SQL injection risk detected - review database queries"
          fi
          
          # Direct file access
          if grep -r "\\$_FILES.*move_uploaded_file" --include="*.php" . 2>/dev/null; then
            echo "âš ï¸ File upload detected - ensure proper validation"
          fi
          
          # eval() usage
          if grep -r "eval(" --include="*.php" . 2>/dev/null; then
            echo "âŒ eval() usage detected - security risk!"
            exit 1
          fi
          
          # Direct database access without preparation
          if grep -r "\\$wpdb->query.*\\$_" --include="*.php" . 2>/dev/null; then
            echo "âš ï¸ Potential unsafe database query detected"
          fi
          
          echo "âœ… Security scan completed"

  compatibility-matrix:
    name: ğŸ§ª PHP Version Matrix Test
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        php-version: ['8.3', '8.4']
        
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ˜ Setup PHP ${{ matrix.php-version }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          
      - name: ğŸ§ª Test PHP Compatibility
        run: |
          echo "ğŸ§ª Testing compatibility with PHP ${{ matrix.php-version }}"
          
          # Test all PHP files can be loaded
          find . -name "*.php" -not -path "./vendor/*" -not -path "./test-*" | while read file; do
            php -f "$file" 2>/dev/null || echo "âš ï¸ Issue loading: $file"
          done
          
          echo "âœ… PHP ${{ matrix.php-version }} compatibility test completed"

  summary:
    name: ğŸ“Š CI Summary
    runs-on: ubuntu-latest
    needs: [php-quality-checks, wordpress-compatibility, code-standards, security-scan, compatibility-matrix]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate Summary
        run: |
          echo "## ğŸ‰ CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| PHP Quality & Compatibility | ${{ needs.php-quality-checks.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| WordPress Compatibility | ${{ needs.wordpress-compatibility.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Standards | ${{ needs.code-standards.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Compatibility Matrix | ${{ needs.compatibility-matrix.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸš€ **Plugin Status:** Ready for PHP 8.3+ and WordPress 6.7+" >> $GITHUB_STEP_SUMMARY